openapi: 3.1.0

info:
  title: Week 5 MVP API
  version: 1.0.0
  description: |
    Week 5 MVP API Implementation
    Endpoints: GET /healthz (health check), POST /convert (temperature conversion), 
    POST /expenses (create expense), GET /expenses/summary (aggregate expenses)

servers:
  - url: http://localhost:3000
    description: Development server

paths:
  /health:
    get:
      summary: Legacy health check endpoint
      description: Returns API health status and current timestamp
      operationId: getHealth
      tags:
        - Health
      responses:
        '200':
          description: API is healthy
          content:
            application/json:
              schema:
                type: object
                required:
                  - status
                  - timestamp
                properties:
                  status:
                    type: string
                    example: "ok"
                    description: Health status indicator
                  timestamp:
                    type: string
                    format: date-time
                    example: "2025-01-27T12:00:00.000Z"
                    description: Current server timestamp in ISO 8601 format

  /healthz:
    get:
      summary: Health Check Endpoint
      description: Returns service health status, version, and current time in ISO 8601 format
      operationId: getHealthz
      tags:
        - Health
      responses:
        '200':
          description: Service is healthy and operational
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthCheckResponse'

  /convert:
    post:
      summary: Temperature Conversion Endpoint
      description: Converts temperature between Celsius and Fahrenheit
      operationId: postConvert
      tags:
        - Conversion
      requestBody:
        required: true
        description: Temperature conversion request
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConversionRequest'
            examples:
              FtoC:
                value:
                  value: 32
                  from: F
                  to: C
                description: Convert 32°F to Celsius
              CtoF:
                value:
                  value: 0
                  from: C
                  to: F
                description: Convert 0°C to Fahrenheit
      responses:
        '200':
          description: Conversion successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversionResponse'
              examples:
                FtoC:
                  value:
                    value: 0
                    unit: C
                  description: Result of 32°F → C conversion
                CtoF:
                  value:
                    value: 32
                    unit: F
                  description: Result of 0°C → F conversion
        '400':
          description: Validation failed - invalid request format or invalid field values
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
              examples:
                missingField:
                  value:
                    error: "Validation failed"
                    details:
                      - code: "invalid_type"
                        path: ["value"]
                        message: "Required"
                  description: Missing required field
                invalidType:
                  value:
                    error: "Validation failed"
                    details:
                      - code: "invalid_type"
                        path: ["value"]
                        message: "Expected number, received string"
                  description: Wrong type for field
                invalidEnum:
                  value:
                    error: "Validation failed"
                    details:
                      - code: "invalid_enum_value"
                        path: ["from"]
                        message: "From unit must be 'C' or 'F'"
                  description: Invalid enum value for unit

  /expenses:
    get:
      summary: Get Expenses with Pagination
      description: Retrieves a paginated list of expense records. Supports pagination via page and pageSize query parameters.
      operationId: getExpenses
      tags:
        - Expenses
      parameters:
        - name: page
          in: query
          required: false
          description: Page number (1-indexed)
          schema:
            type: integer
            default: 1
            minimum: 1
          example: 1
        - name: pageSize
          in: query
          required: false
          description: Number of items per page
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
          example: 20
        - name: request-id
          in: header
          required: false
          description: Request correlation ID for tracking and debugging
          schema:
            type: string
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        '200':
          description: List of expenses retrieved successfully with pagination metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedExpenseResponse'
              examples:
                firstPage:
                  value:
                    data:
                      - id: "550e8400-e29b-41d4-a716-446655440000"
                        amount: 25.50
                        category: "food"
                        date: "2025-11-05"
                      - id: "660e8400-e29b-41d4-a716-446655440001"
                        amount: 100.00
                        category: "transport"
                        date: "2025-11-01"
                    pagination:
                      totalItems: 50
                      currentPage: 1
                      pageSize: 20
                      totalPages: 3
                  description: First page of expenses with pagination metadata
        '400':
          description: Bad Request - invalid pagination parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
              examples:
                invalidPage:
                  value:
                    code: "VALIDATION_ERROR"
                    message: "Invalid pagination parameters"
                    details:
                      - field: "page"
                        message: "page must be greater than or equal to 1"
                    requestId: "550e8400-e29b-41d4-a716-446655440000"
                  description: Invalid page number
                invalidPageSize:
                  value:
                    code: "VALIDATION_ERROR"
                    message: "Invalid pagination parameters"
                    details:
                      - field: "pageSize"
                        message: "pageSize must be between 1 and 100"
                    requestId: "550e8400-e29b-41d4-a716-446655440000"
                  description: Invalid page size
        '500':
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
              examples:
                serverError:
                  value:
                    code: "INTERNAL_ERROR"
                    message: "An unexpected error occurred"
                    requestId: "550e8400-e29b-41d4-a716-446655440000"
                  description: Server error response

    post:
      summary: Create Expense
      description: Creates a new expense record with amount, category, and date. Returns the created expense with assigned UUID.
      operationId: postExpense
      tags:
        - Expenses
      parameters:
        - name: request-id
          in: header
          required: false
          description: Request correlation ID for tracking and debugging
          schema:
            type: string
          example: "550e8400-e29b-41d4-a716-446655440000"
      requestBody:
        required: true
        description: Expense creation request
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateExpenseRequest'
            examples:
              foodExpense:
                value:
                  amount: 25.50
                  category: food
                  date: "2025-11-05"
                description: Create a food expense
              transportExpense:
                value:
                  amount: 100.00
                  category: transport
                  date: "2025-11-01"
                description: Create a transport expense
      responses:
        '201':
          description: Expense created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Expense'
              examples:
                success:
                  value:
                    id: "550e8400-e29b-41d4-a716-446655440000"
                    amount: 25.50
                    category: food
                    date: "2025-11-05"
                  description: Successfully created expense with assigned UUID
        '400':
          description: Validation failed - invalid or missing required fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
              examples:
                negativeAmount:
                  value:
                    code: "VALIDATION_ERROR"
                    message: "Validation failed"
                    details:
                      - field: "amount"
                        message: "amount must be greater than 0"
                    requestId: "550e8400-e29b-41d4-a716-446655440000"
                  description: Amount must be positive
                invalidDate:
                  value:
                    code: "VALIDATION_ERROR"
                    message: "Validation failed"
                    details:
                      - field: "date"
                        message: "date must be in YYYY-MM-DD format (received: 11/05/2025)"
                    requestId: "550e8400-e29b-41d4-a716-446655440000"
                  description: Invalid date format
                missingField:
                  value:
                    code: "VALIDATION_ERROR"
                    message: "Validation failed"
                    details:
                      - field: "category"
                        message: "category is required"
                    requestId: "550e8400-e29b-41d4-a716-446655440000"
                  description: Missing required field
        '422':
          description: Unprocessable Entity - business logic validation failure
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
              examples:
                businessRuleViolation:
                  value:
                    code: "BUSINESS_RULE_VIOLATION"
                    message: "Expense violates business rules"
                    details:
                      reason: "Expense date cannot be in the future"
                    requestId: "550e8400-e29b-41d4-a716-446655440000"
                  description: Business rule violation
        '500':
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
              examples:
                serverError:
                  value:
                    code: "INTERNAL_ERROR"
                    message: "An unexpected error occurred"
                    requestId: "550e8400-e29b-41d4-a716-446655440000"
                  description: Server error response

  /expenses/summary:
    get:
      summary: Get Expense Summary
      description: Retrieves aggregated expense data with optional filtering by category and/or month. Returns total amount, count, and applied filters.
      operationId: getExpenseSummary
      tags:
        - Expenses
      parameters:
        - name: request-id
          in: header
          required: false
          description: Request correlation ID for tracking and debugging
          schema:
            type: string
          example: "550e8400-e29b-41d4-a716-446655440000"
        - name: category
          in: query
          required: false
          description: Filter expenses by category name (case-sensitive)
          schema:
            type: string
          example: "food"
        - name: month
          in: query
          required: false
          description: Filter expenses by month in YYYY-MM format
          schema:
            type: string
            pattern: '^\d{4}-\d{2}$'
          example: "2025-11"
      responses:
        '200':
          description: Expense summary retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExpenseSummary'
              examples:
                noFilters:
                  value:
                    total: 150.75
                    count: 5
                    filters: {}
                  description: Summary of all expenses
                categoryFilter:
                  value:
                    total: 45.50
                    count: 2
                    filters:
                      category: "food"
                  description: Summary filtered by category
                monthFilter:
                  value:
                    total: 230.00
                    count: 8
                    filters:
                      month: "2025-11"
                  description: Summary filtered by month
                bothFilters:
                  value:
                    total: 12.99
                    count: 1
                    filters:
                      category: "food"
                      month: "2025-11"
                  description: Summary with both category and month filters
                empty:
                  value:
                    total: 0
                    count: 0
                    filters:
                      category: "nonexistent"
                  description: Empty result when no expenses match filters
        '400':
          description: Bad Request - invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
              examples:
                invalidMonth:
                  value:
                    code: "VALIDATION_ERROR"
                    message: "Invalid query parameters"
                    details:
                      - field: "month"
                        message: "month must be in YYYY-MM format"
                    requestId: "550e8400-e29b-41d4-a716-446655440000"
                  description: Invalid month format
        '500':
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
              examples:
                serverError:
                  value:
                    code: "INTERNAL_ERROR"
                    message: "An unexpected error occurred"
                    requestId: "550e8400-e29b-41d4-a716-446655440000"
                  description: Server error response

components:
  schemas:
    ErrorEnvelope:
      type: object
      description: Standardized error response format used across all endpoints
      required:
        - code
        - message
      properties:
        code:
          type: string
          description: Machine-readable error code
          example: "VALIDATION_ERROR"
        message:
          type: string
          description: Human-readable error message
          example: "Validation failed"
        details:
          oneOf:
            - type: array
              description: Array of field-specific validation errors
              items:
                type: object
                properties:
                  field:
                    type: string
                    description: Field name that failed validation
                    example: "amount"
                  message:
                    type: string
                    description: Error message for the field
                    example: "amount must be greater than 0"
            - type: object
              description: Additional error context
              additionalProperties: true
          example:
            - field: "amount"
              message: "amount must be greater than 0"
        requestId:
          type: string
          description: Request correlation ID (echoed from request-id header)
          example: "550e8400-e29b-41d4-a716-446655440000"

    HealthCheckResponse:
      type: object
      description: Health check response with service status and version
      required:
        - status
        - version
        - currentTime
      properties:
        status:
          type: string
          description: Service health indicator (typically 'ok')
          example: "ok"
        version:
          type: string
          description: API version in semantic versioning format (X.Y.Z)
          pattern: '^\d+\.\d+\.\d+$'
          example: "1.0.0"
        currentTime:
          type: string
          format: date-time
          description: Current server time in ISO 8601 UTC format
          example: "2025-01-27T12:00:00.000Z"

    ConversionRequest:
      type: object
      description: Temperature conversion request
      required:
        - value
        - from
        - to
      properties:
        value:
          type: number
          description: Temperature value to convert (integer or decimal)
          example: 32
        from:
          type: string
          description: Source temperature unit
          enum: [C, F]
          example: F
        to:
          type: string
          description: Target temperature unit
          enum: [C, F]
          example: C

    ConversionResponse:
      type: object
      description: Temperature conversion response
      required:
        - value
        - unit
      properties:
        value:
          type: number
          description: Converted temperature value
          example: 0
        unit:
          type: string
          description: Target temperature unit
          enum: [C, F]
          example: C

    ValidationErrorResponse:
      type: object
      description: Validation error response with detailed error information
      required:
        - error
        - details
      properties:
        error:
          type: string
          description: Error type indicator
          const: "Validation failed"
          example: "Validation failed"
        details:
          type: array
          description: Array of validation errors
          items:
            type: object
            properties:
              code:
                type: string
                description: Zod error code (e.g., invalid_type, invalid_enum_value)
                example: "invalid_type"
              path:
                type: array
                description: JSON path to the field with error
                items:
                  oneOf:
                    - type: string
                    - type: number
                example: ["value"]
              message:
                type: string
                description: Human-readable error message
                example: "Required"

    CreateExpenseRequest:
      type: object
      description: Request to create a new expense
      required:
        - amount
        - category
        - date
      properties:
        amount:
          type: number
          description: Expense amount (must be positive, > 0)
          exclusiveMinimum: 0
          example: 25.50
        category:
          type: string
          description: Expense category (non-empty string)
          minLength: 1
          example: "food"
        date:
          type: string
          format: date
          description: Expense date in ISO 8601 format (YYYY-MM-DD)
          pattern: '^\d{4}-\d{2}-\d{2}$'
          example: "2025-11-05"

    Expense:
      type: object
      description: Expense record returned by POST /expenses
      required:
        - id
        - amount
        - category
        - date
      properties:
        id:
          type: string
          format: uuid
          description: Unique expense identifier (auto-assigned by server)
          example: "550e8400-e29b-41d4-a716-446655440000"
        amount:
          type: number
          description: Expense amount
          example: 25.50
        category:
          type: string
          description: Expense category
          example: "food"
        date:
          type: string
          format: date
          description: Expense date (YYYY-MM-DD format)
          example: "2025-11-05"

    ExpenseErrorResponse:
      type: object
      description: Validation error response for expense endpoints
      required:
        - errors
      properties:
        errors:
          type: array
          description: Array of validation errors with field names and messages
          items:
            type: object
            required:
              - field
              - message
            properties:
              field:
                type: string
                description: Field name that failed validation
                example: "amount"
              message:
                type: string
                description: Descriptive error message for the field
                example: "amount must be greater than 0"

    ExpenseSummary:
      type: object
      description: Aggregated expense data with optional filters
      required:
        - total
        - count
        - filters
      properties:
        total:
          type: number
          description: Sum of expense amounts matching filter criteria
          minimum: 0
          example: 150.75
        count:
          type: integer
          description: Number of expenses matching filter criteria
          minimum: 0
          example: 5
        filters:
          type: object
          description: Filters applied to generate this summary
          properties:
            category:
              type: string
              description: Category filter applied (if present)
              example: "food"
            month:
              type: string
              description: Month filter applied in YYYY-MM format (if present)
              pattern: '^\d{4}-\d{2}$'
              example: "2025-11"
          additionalProperties: false

    PaginationMetadata:
      type: object
      description: Metadata about pagination state for GET /expenses response
      required:
        - totalItems
        - currentPage
        - pageSize
        - totalPages
      properties:
        totalItems:
          type: integer
          description: Total count of expenses matching query
          minimum: 0
          example: 50
        currentPage:
          type: integer
          description: Current page number (1-indexed)
          minimum: 1
          example: 1
        pageSize:
          type: integer
          description: Number of items per page
          minimum: 1
          maximum: 100
          example: 20
        totalPages:
          type: integer
          description: Total number of pages (calculated as Math.ceil(totalItems / pageSize))
          minimum: 0
          example: 3

    PaginatedExpenseResponse:
      type: object
      description: Wrapped response structure for GET /expenses endpoint with pagination metadata
      required:
        - data
        - pagination
      properties:
        data:
          type: array
          description: Array of expense records
          items:
            $ref: '#/components/schemas/Expense'
        pagination:
          $ref: '#/components/schemas/PaginationMetadata'
