# Phase 1: Data Model & Entity Definitions

**Feature**: Week 4 Finisher - Playwright E2E Smokes (5 UIs)  
**Date**: 2025-11-02  
**Status**: Complete

## Entity Diagram

```
┌─────────────────────────────────────────────┐
│       Smoke Test Suite                      │
│  (Collection of 5 UI smoke tests)           │
├─────────────────────────────────────────────┤
│ - suite_id: UUID                            │
│ - created_at: ISO8601 timestamp             │
│ - execution_duration: number (ms)           │
│ - status: 'PASSED' | 'FAILED' | 'RUNNING'  │
│ - browser: 'chromium' (fixed)               │
│ - total_tests: 5 (fixed)                    │
└────────────────────┬────────────────────────┘
                     │
                     │ contains 5
                     │
        ┌────────────┼────────────┐
        │            │            │
        v            v            v
  ┌──────────┐ ┌──────────┐ ┌──────────┐
  │  Test A  │ │  Test B  │ │  Test C  │ ...
  │ (Hello)  │ │ (Stop    │ │  (Temp)  │
  │          │ │  watch)  │ │          │
  └────┬─────┘ └────┬─────┘ └────┬─────┘
       │            │            │
       │ generates  │            │
       │            │            │
       v            v            v
  ┌───────────────────────────────────────┐
  │       Test Artifact                   │
  │  (Screenshot, Trace, Test Metadata)   │
  ├───────────────────────────────────────┤
  │ - artifact_id: UUID                   │
  │ - test_id: string (hello, stopwatch..)│
  │ - artifact_type: enum (screenshot,    │
  │   trace, report)                      │
  │ - path: string (file path in CI)      │
  │ - timestamp: ISO8601                  │
  │ - failure_reason: string | null       │
  │ - execution_time: number (ms)         │
  └───────────────────────────────────────┘
        │
        │
        v
  ┌────────────────────┐
  │  CI Job Config     │
  │ (GitHub Actions    │
  │  Workflow Config)  │
  ├────────────────────┤
  │ - workflow_id: str │
  │ - runner: str      │
  │ - timeout: number  │
  │ - retries: number  │
  │ - artifacts: [str] │
  └────────────────────┘
```

---

## Entity Definitions

### 1. Smoke Test Suite

**Purpose**: Container for all 5 UI smoke tests; tracks aggregate execution status.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `suite_id` | UUID | Yes | Unique identifier (auto-generated per CI run) |
| `created_at` | ISO8601 | Yes | Test suite execution start timestamp |
| `execution_duration` | number (ms) | Yes | Total time for all 5 tests (must be ≤120000) |
| `status` | enum | Yes | `PASSED` = all 5 passed; `FAILED` = ≥1 failed; `RUNNING` = executing |
| `browser` | enum | Yes | Fixed value: `'chromium'` |
| `total_tests` | number | Yes | Fixed value: `5` |
| `tests` | Test[] | Yes | Array of 5 Test objects (see Test entity) |
| `artifacts` | Artifact[] | No | Array of Artifact objects generated by tests |

**Validation Rules**:
- `execution_duration` MUST be ≤ 120,000 ms (2 minutes); if exceeded, suite status = `FAILED`
- `browser` MUST equal `'chromium'`; no other values allowed
- `total_tests` MUST equal `5`; enforced by schema
- `status` = `PASSED` only if all 5 tests have status `PASSED`
- `created_at` MUST be valid ISO8601 timestamp

**Lifecycle**:
1. Created at CI job start
2. Updated after each test completes (status transitions)
3. Finalized after all 5 tests complete or timeout occurs
4. Artifacts indexed in review-packet

---

### 2. Test (Smoke Test)

**Purpose**: Individual smoke test targeting a single UI; carries execution metadata.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `test_id` | string | Yes | Unique identifier: `'hello'`, `'stopwatch'`, `'temperature'`, `'expense'`, `'todo'` |
| `ui_target` | enum | Yes | Target UI: `'hello'`, `'stopwatch'`, `'temperature'`, `'expense'`, `'todo'` |
| `endpoint` | string | Yes | App URL: `/`, `/stopwatch`, `/temp`, `/expense`, `/todo` |
| `status` | enum | Yes | `PASSED`, `FAILED`, `SKIPPED`, `RUNNING`, `TIMEOUT` |
| `execution_time` | number (ms) | Yes | Actual execution time (must be ≤30000) |
| `timeout_threshold` | number (ms) | Yes | Fixed value: `30000` (30 seconds) |
| `retry_count` | number | Yes | Fixed value: `0` (no retries) |
| `assertions` | Assertion[] | Yes | Array of assertions in test |
| `error` | object | No | If status = `FAILED`, error details: `{ code, message, stack }` |

**Validation Rules**:
- `test_id` MUST be one of: `'hello'`, `'stopwatch'`, `'temperature'`, `'expense'`, `'todo'`
- `execution_time` MUST be ≤ 30,000 ms; if exceeded, status = `TIMEOUT`
- `timeout_threshold` MUST be `30000`
- `retry_count` MUST be `0`
- `status` = `FAILED` if any assertion fails or timeout occurs
- `error` is required if status = `FAILED`; must include `code`, `message`, `stack`

**Lifecycle**:
1. Created when test execution starts
2. Updated as assertions execute
3. Status finalized when all assertions complete or timeout
4. Artifacts generated based on final status

---

### 3. Assertion

**Purpose**: Individual check within a test (e.g., "heading is visible", "count incremented").

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `assertion_id` | string | Yes | Unique within test (auto-generated) |
| `description` | string | Yes | Human-readable assertion text |
| `status` | enum | Yes | `PASSED` or `FAILED` |
| `expected` | any | Yes | Expected value or condition |
| `actual` | any | No | Actual value (if applicable) |
| `line_number` | number | No | Line in test file where assertion defined |

**Validation Rules**:
- `description` MUST be non-empty string
- `status` MUST be `PASSED` or `FAILED`
- If `status` = `FAILED`, `actual` MUST be populated (for debugging)

---

### 4. Test Artifact

**Purpose**: File (screenshot, trace, report) generated during or after test execution.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `artifact_id` | UUID | Yes | Unique identifier |
| `test_id` | string | Yes | Reference to Test (foreign key): `'hello'`, `'stopwatch'`, etc. |
| `artifact_type` | enum | Yes | `'screenshot'`, `'trace'`, `'html_report'` |
| `file_path` | string | Yes | Relative path in CI: `screenshots/hello-TIMESTAMP.png` |
| `file_size` | number (bytes) | Yes | Size of artifact file |
| `mime_type` | string | Yes | MIME type: `'image/png'`, `'application/zip'`, `'text/html'` |
| `created_at` | ISO8601 | Yes | Timestamp when artifact generated |
| `failure_reason` | string | No | If artifact created on failure, reason (e.g., "assertion failed") |
| `url_in_review_packet` | string | No | Generated URL in `review-artifacts/index.html` |

**Validation Rules**:
- `artifact_type` MUST be one of: `'screenshot'`, `'trace'`, `'html_report'`
- `file_path` MUST be valid relative path (no `..`, no absolute paths)
- `file_size` MUST be > 0
- `mime_type` MUST match `artifact_type`
- Screenshot: `'image/png'`
- Trace: `'application/zip'`
- Report: `'text/html'`
- `created_at` MUST be valid ISO8601

**Generation Rules**:
- Screenshots: Captured on test failure (any assertion fails or timeout)
- Traces: Captured on test failure (`trace: 'on-first-failure'`)
- HTML Report: Generated on test suite success (all 5 tests pass)

**Lifecycle**:
1. Generated during/after test execution
2. Uploaded to GitHub Actions artifact storage
3. Indexed in `review-artifacts/index.html`
4. Retained per GitHub Actions policy (default: 30 days)

---

### 5. CI Job Configuration

**Purpose**: GitHub Actions workflow configuration; defines test execution parameters.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `job_id` | string | Yes | GitHub Actions job identifier (auto-generated) |
| `workflow_file` | string | Yes | Fixed: `.github/workflows/playwright-e2e-smoke.yml` |
| `trigger_event` | enum | Yes | `'push'` or `'pull_request'` |
| `runner` | string | Yes | Fixed: `'ubuntu-latest'` |
| `node_version` | string | Yes | Fixed: `'18'` or `'18.x'` |
| `playwright_version` | string | Yes | Fixed: `'@playwright/test ^1.40.0'` (or latest stable) |
| `timeout_per_job` | number (seconds) | Yes | Workflow job timeout (fixed: `300` = 5 min soft limit, 2-min suite execution) |
| `artifact_retention` | number (days) | Yes | Fixed: `30` (GitHub Actions default) |
| `parallel_jobs` | number | Yes | Fixed: `1` for smoke suite (could be parallelized in future) |

**Validation Rules**:
- `workflow_file` MUST be exactly `.github/workflows/playwright-e2e-smoke.yml`
- `runner` MUST be `'ubuntu-latest'`
- `node_version` MUST be `'18'` or `'18.x'`
- `playwright_version` MUST match `^1.40.0` or approved later stable version
- `timeout_per_job` MUST be ≥ 300 seconds (soft limit; suite must finish in ≤120 seconds)
- `artifact_retention` MUST be ≥ 30 days

**Lifecycle**:
1. Defined in `.github/workflows/playwright-e2e-smoke.yml`
2. Loaded by GitHub Actions on trigger (push or PR)
3. Executed on runner matching configuration
4. Updated only via PR changes to workflow file

---

## Relationships & Cardinality

```
SmokeTestSuite [1] ──contains─→ [5] Test
                   (exactly 5 tests per suite)

Test [1] ──generates→ [0..n] Artifact
         (0 artifacts if passed; ≥1 if failed)

Test [1] ──uses→ [1] CIJobConfiguration
         (all tests use same CI config)

Artifact [n] ──indexed_in→ [1] ReviewPacket
          (all artifacts referenced in review-packet/index.html)
```

---

## State Transitions

### Test State Machine

```
       START
        │
        ▼
    [RUNNING] ──(timeout)──→ [TIMEOUT] ──→ [FAILED]
        │
        ├─(assertion pass)─→ continue
        │
        ├─(assertion fail)─→ [FAILED]
        │
        └─(all pass)────────→ [PASSED]
```

### Suite State Machine

```
       START
        │
        ▼
    [RUNNING]
        │
        ├─(test 1 complete) ──→ continue
        ├─(test 2 complete) ──→ continue
        ├─(test 3 complete) ──→ continue
        ├─(test 4 complete) ──→ continue
        ├─(test 5 complete) ──→ [FINALIZING]
        │
        ├─(timeout at suite level) ──→ [FAILED]
        │
        └─(after all tests)
                │
                ├─(all PASSED) ──→ [PASSED]
                └─(any FAILED) ──→ [FAILED]
```

---

## Validation Scenarios

### Scenario 1: Successful Test Suite
```
Suite: [PASSED]
├─ Test 'hello': [PASSED] (15.2s)
│  └─ Artifacts: html_report/index.html
├─ Test 'stopwatch': [PASSED] (18.5s)
│  └─ Artifacts: html_report/index.html
├─ Test 'temperature': [PASSED] (12.8s)
│  └─ Artifacts: html_report/index.html
├─ Test 'expense': [PASSED] (22.1s)
│  └─ Artifacts: html_report/index.html
├─ Test 'todo': [PASSED] (19.4s)
│  └─ Artifacts: html_report/index.html
└─ Execution Time: 88.0s (✓ within 2-min budget)
```

### Scenario 2: Failed Test with Artifacts
```
Suite: [FAILED]
├─ Test 'hello': [PASSED] (15.2s)
├─ Test 'stopwatch': [FAILED] (30.0s timeout)
│  └─ Artifacts: 
│     ├─ screenshot: stopwatch-failure-001.png
│     └─ trace: stopwatch-failure-001.zip
├─ Test 'temperature': [PASSED] (12.8s)
├─ Test 'expense': [PASSED] (22.1s)
├─ Test 'todo': [PASSED] (19.4s)
└─ Execution Time: 99.5s (suite continues despite test 2 failure)
   → Artifacts indexed in review-artifacts/index.html
```

### Scenario 3: Suite Timeout
```
Suite: [FAILED]
├─ Test 'hello': [PASSED] (15.2s)
├─ Test 'stopwatch': [PASSED] (18.5s)
├─ Test 'temperature': [RUNNING] (at 121s total) ──→ [TIMEOUT]
│  └─ Artifacts: screenshot (current page state)
├─ Test 'expense': [SKIPPED] (no time to start)
├─ Test 'todo': [SKIPPED] (no time to start)
└─ Execution Time: 121.0s (✗ exceeds 2-min budget)
   → Job fails; developer alerted to performance issue
```

---

## Constraints & Invariants

| Invariant | Enforcement | Rationale |
|-----------|-------------|-----------|
| Suite execution ≤ 2 min | GitHub Actions job timeout + timing check | Performance SLA |
| Test execution ≤ 30 sec | Playwright `globalTimeout` | Per-test budget |
| Exactly 5 tests per suite | Schema enforcement | Feature requirement |
| Chromium only | Playwright config | Performance & consistency |
| No retries | Playwright config (`retries: 0`) | Determinism |
| All tests run (collect-all) | GitHub Actions `if: always()` | Full visibility |
| Screenshots on failure | Playwright config | Debugging |
| Traces on first failure | Playwright config | Root cause analysis |

---

## Next Phase

**Phase 2: Task Planning** will convert these entities into:
- Contract test implementations (5 failing tests)
- CI workflow configuration (GitHub Actions)
- Review-packet integration logic
- End-to-end validation steps
