# Contract 3: Review-Packet Coverage Integration

**Purpose**: Define how coverage reports are integrated into the review-packet artifact for historical tracking and accessibility.

**Files**:
- `.github/workflows/review-packet.yml` (or equivalent)
- `review-artifacts/index.html` (updated with coverage summary)
- `review-artifacts/coverage/` (new directory for coverage artifacts)

---

## Input

**Current State**:
- Review-packet workflow exists and generates artifact
- Coverage reports generated by Vitest (`coverage/` directory)
- Review-packet may not include coverage data

---

## Output

**Desired State**:
- Coverage artifacts copied to `review-artifacts/coverage/` during CI
- Coverage summary table added to `review-artifacts/index.html`
- Coverage metrics accessible from review-packet index
- Coverage preserved even when tests fail
- Coverage integrated into review-packet for PR review process

---

## Directory Structure

```
review-artifacts/
├── index.html                    # Main review-packet index (updated with coverage)
├── coverage/                     # NEW: Coverage artifacts directory
│   ├── coverage-final.json       # Machine-readable coverage data
│   ├── index.html                # Human-readable coverage report
│   └── [other coverage files]
├── [existing artifacts]
└── [other review data]
```

---

## Workflow Integration Example

```yaml
# .github/workflows/review-packet.yml (relevant sections)

name: Review Packet

on:
  pull_request:
    branches: [main, development]

jobs:
  review-packet:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      # Generate coverage reports
      - name: Run tests with coverage
        run: npm run test:coverage
        continue-on-error: true  # Allow workflow to continue even if coverage fails
      
      # Create review-artifacts directory structure
      - name: Prepare review-artifacts
        run: |
          mkdir -p review-artifacts/coverage
          mkdir -p review-artifacts/logs
      
      # Copy coverage to review-artifacts
      - name: Copy coverage artifacts
        if: always()
        run: |
          if [ -d coverage ]; then
            cp -r coverage/* review-artifacts/coverage/ 2>/dev/null || true
          fi
      
      # Generate or update index.html with coverage summary
      - name: Generate coverage summary for index
        if: always()
        run: |
          node scripts/generate-coverage-summary.js \
            coverage/coverage-final.json \
            review-artifacts/coverage-summary.json
      
      # Update index.html with coverage metrics
      - name: Update review-packet index
        if: always()
        run: |
          node scripts/update-review-index.js \
            review-artifacts/index.html \
            review-artifacts/coverage-summary.json
      
      # Upload final review-packet
      - name: Upload review-packet
        uses: actions/upload-artifact@v3
        with:
          name: review-packet
          path: review-artifacts/
          retention-days: 60
```

---

## Index HTML Update Format

**Coverage Summary Section** (added to `review-artifacts/index.html`):

```html
<section id="coverage-summary">
  <h2>Coverage Metrics</h2>
  
  <table>
    <thead>
      <tr>
        <th>Metric</th>
        <th>Coverage</th>
        <th>Threshold</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      <tr class="pass">
        <td>Statements</td>
        <td>65%</td>
        <td>60%</td>
        <td>✅ PASS</td>
      </tr>
      <tr class="pass">
        <td>Branches</td>
        <td>55%</td>
        <td>50%</td>
        <td>✅ PASS</td>
      </tr>
      <tr class="pass">
        <td>Functions</td>
        <td>62%</td>
        <td>60%</td>
        <td>✅ PASS</td>
      </tr>
      <tr class="pass">
        <td>Lines</td>
        <td>63%</td>
        <td>60%</td>
        <td>✅ PASS</td>
      </tr>
    </tbody>
  </table>
  
  <p>
    <a href="coverage/index.html">View detailed coverage report →</a>
  </p>
</section>
```

---

## Data Files Required

### File 1: `coverage-final.json`

**Source**: Generated by Vitest during `npm run test:coverage`

**Content**: Standard Vitest coverage JSON format
```json
{
  "files": {
    "src/app.js": { "statements": {...}, "branches": {...} },
    "frontend/src/ui-button.js": {...}
  },
  "totals": {
    "statements": {"total": 100, "covered": 65, "pct": 65},
    "branches": {"total": 80, "covered": 44, "pct": 55},
    "functions": {"total": 50, "covered": 31, "pct": 62},
    "lines": {"total": 95, "covered": 60, "pct": 63}
  }
}
```

**Location**: `review-artifacts/coverage/coverage-final.json`

---

### File 2: `coverage/index.html`

**Source**: Generated by Vitest during `npm run test:coverage`

**Content**: Human-readable HTML coverage report with:
- File-by-file coverage breakdown
- Color-coded coverage percentages (red = poor, yellow = partial, green = good)
- Navigation between files
- Line-by-line coverage highlighting (if available)

**Location**: `review-artifacts/coverage/index.html`

---

### File 3: `coverage-summary.json`

**Generated by**: `scripts/generate-coverage-summary.js` (custom script)

**Content**: Parsed summary from coverage-final.json
```json
{
  "generated_at": "2025-10-29T10:30:00Z",
  "thresholds": {
    "statements": 60,
    "branches": 50,
    "functions": 60,
    "lines": 60
  },
  "metrics": {
    "statements": {"covered": 65, "total": 100, "pct": 65, "passed": true},
    "branches": {"covered": 44, "total": 80, "pct": 55, "passed": true},
    "functions": {"covered": 31, "total": 50, "pct": 62, "passed": true},
    "lines": {"covered": 60, "total": 95, "pct": 63, "passed": true}
  },
  "all_thresholds_met": true,
  "overall_status": "PASS"
}
```

---

## Validation Rules

### Rule 1: Artifact Preservation

- ✅ Coverage artifacts copied to `review-artifacts/coverage/`
- ✅ Artifacts preserved even if tests fail (`if: always()`)
- ✅ Files readable and accessible

**Validation**:
```bash
# After CI runs:
ls -la review-artifacts/coverage/
file review-artifacts/coverage/coverage-final.json
file review-artifacts/coverage/index.html
```

---

### Rule 2: Index Update

- ✅ Coverage summary table added to index.html
- ✅ Table includes: Metric, Coverage %, Threshold, Status
- ✅ Pass/Fail status clearly marked (✅ / ❌)
- ✅ Link to detailed report included

**Validation**:
```bash
grep -c "Coverage Metrics\|Statements\|coverage/index.html" \
  review-artifacts/index.html
# Should find all three
```

---

### Rule 3: Data Integrity

- ✅ `coverage-final.json` is valid JSON
- ✅ All required fields present (files, totals, metrics)
- ✅ Numbers match: `covered ≤ total` for all metrics
- ✅ Percentages calculated correctly: `covered / total * 100`

**Validation**:
```bash
cat review-artifacts/coverage/coverage-final.json | jq . > /dev/null
# If valid JSON, exits 0; otherwise exits 1
```

---

### Rule 4: Accessibility

- ✅ Coverage summary visible from main review-packet index
- ✅ Link to detailed report accessible from index
- ✅ All files accessible via artifact download

**Validation**:
1. Download review-packet artifact from GitHub Actions
2. Open `review-artifacts/index.html` in browser
3. Verify coverage table visible
4. Click coverage report link
5. Verify detailed report opens (`coverage/index.html`)

---

### Rule 5: Historical Tracking

- ✅ Artifacts retained for specified period (≥30 days)
- ✅ Each PR build has separate artifact
- ✅ Coverage metrics can be compared across PRs

**Validation**:
```yaml
# In workflow:
retention-days: 60  # Or other value > 30
# Ensures artifacts kept for history
```

---

## Test Scenarios

### Scenario 1: Coverage Passes - All Data Captured

**Setup**:
1. Code with 65% statements, 55% branches, 62% functions, 63% lines
2. CI workflow runs
3. Review-packet generated

**Expected**:
- ✅ `review-artifacts/coverage/coverage-final.json` exists
- ✅ `review-artifacts/coverage/index.html` exists
- ✅ Index table shows all "✅ PASS" rows
- ✅ `overall_status: "PASS"` in summary

---

### Scenario 2: Coverage Fails - Data Still Captured

**Setup**:
1. Code with 40% statements, 55% branches, 61% functions, 45% lines
2. CI workflow runs (continues-on-error: true)
3. Review-packet generated

**Expected**:
- ✅ `review-artifacts/coverage/` still populated
- ✅ Index table shows mix of ✅ and ❌ rows
- ✅ `overall_status: "FAIL"` in summary
- ✅ Coverage data available for debugging

---

### Scenario 3: No Tests - Graceful Handling

**Setup**:
1. Code with no tests (0% coverage)
2. CI workflow runs with `continue-on-error: true`
3. Review-packet generated

**Expected**:
- ✅ Review-packet created (not empty)
- ✅ Coverage section present but shows 0% metrics
- ✅ All ❌ status for failed thresholds
- ✅ Clear indication of coverage gap

---

### Scenario 4: Historical Tracking

**Setup**:
1. PR #1: Run workflow → Coverage 65% → Artifact retained
2. PR #2: Run workflow → Coverage 55% → New artifact retained
3. PR #3: Run workflow → Coverage 70% → New artifact retained

**Expected**:
- ✅ Each PR has separate review-packet artifact
- ✅ Artifacts accessible for 60 days (per retention-days)
- ✅ Coverage metrics show trend: 65% → 55% → 70%
- ✅ Can compare coverage across PRs

---

## Success Criteria

✅ Coverage artifacts copied to review-artifacts/coverage/  
✅ coverage-final.json and index.html both present  
✅ Coverage summary table added to review-packet index  
✅ Pass/Fail status clearly marked  
✅ Link to detailed report included  
✅ Artifacts preserved even on test failure  
✅ Data accessible and readable  
✅ Historical artifacts retained ≥30 days  
✅ Integrates with existing review-packet workflow

---

## Related Artifacts

- **Vitest Config Contract**: `vitest-config.md` (generates coverage data)
- **GitHub Actions Contract**: `github-actions-ci.md` (runs tests)
- **Specification**: `/specs/016-week-4-finisher/spec.md` (FR-009)

---

## Notes

- Review-packet workflow should have `continue-on-error: true` for coverage step
  - Allows CI to complete even if coverage fails (different from checks.yml)
  - Enables artifact capture regardless of pass/fail
  - Hard block enforcement happens in checks.yml (different workflow)

- Coverage data is read-only in review-packet
  - Used for review and historical reference
  - Not used to make merge decisions (that's checks.yml job)
  - Provides full context for reviewers

---
