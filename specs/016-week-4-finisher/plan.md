
# Implementation Plan: Configure and Enforce Coverage Thresholds

**Branch**: `016-week-4-finisher` | **Date**: 2025-10-29 | **Spec**: `/specs/016-week-4-finisher/spec.md`
**Input**: Feature specification from `/specs/016-week-4-finisher/spec.md`

## Execution Flow (/plan command scope)
```
1. Load feature spec from Input path ✓
2. Fill Technical Context ✓
3. Fill Constitution Check ✓
4. Execute Phase 0 → research.md ✓
5. Execute Phase 1 → contracts, data-model.md, quickstart.md
6. Re-evaluate Constitution Check ✓
7. Plan Phase 2 → Task generation approach
8. STOP - Ready for /tasks command
```

## Summary
This feature addresses the Week 4 priority to configure and enforce code coverage thresholds in the Vitest test suite. The goal is to establish a quality gate ensuring minimum coverage of 60% statements, 60% lines, 60% functions, and 50% branches across the entire codebase while excluding non-application code (build artifacts, test files, review materials). CI enforcement will prevent merges of PRs that fail to meet thresholds, and coverage reports will be integrated into the review-packet artifact for historical tracking.

## Technical Context
**Language/Version**: JavaScript/TypeScript (ES2020+)  
**Primary Dependencies**: Vitest, GitHub Actions (CI), Prettier (formatting)  
**Storage**: GitHub Actions artifacts (CI review-packet)  
**Testing**: Vitest unit testing framework  
**Target Platform**: Node.js CI environment + local development  
**Project Type**: Web application (frontend + backend components with monorepo structure)  
**Performance Goals**: Threshold evaluation must complete in <5 seconds during CI test execution  
**Constraints**: Configuration MUST be immutable once set; no per-module overrides allowed; hard-block enforcement (no override mechanism)  
**Scale/Scope**: Global configuration affecting entire codebase; applies to ~80-100 source files across UI and backend modules

## Constitution Check
*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

**Applying Constitution v1.1.0 Principles**:

| Principle | Status | Check |
|-----------|--------|-------|
| **I. No Logic Duplication** | ✅ PASS | Coverage configuration is infrastructure-only; no business logic reimplemented |
| **II. Test Coverage Mandate** | ✅ PASS | This feature *implements* the coverage mandate; enforces ≥40% UI + global thresholds |
| **III. Reviewability is Paramount** | ✅ PASS | Coverage reports integrated into review-packet artifact per requirement FR-009 |
| **IV. PR Craft** | ✅ PASS | Configuration files <300 LOC; no business logic changes |
| **V. Simplicity & Consistency** | ✅ PASS | Uses existing Vitest + GitHub Actions; no new tooling required |

**Governance Check**: Configuration locked at 60/50/60/60 per FR-011; changes require spec amendment + team consensus (no dynamic adjustments).

**Verdict**: ✅ **CONSTITUTION COMPLIANT** - No violations. Proceed to Phase 0.

## Project Structure

### Documentation (this feature)
```
specs/016-week-4-finisher/
├── spec.md              # Feature specification (completed)
├── plan.md              # This file (/plan command output)
├── research.md          # Phase 0 output (/plan command)
├── data-model.md        # Phase 1 output (/plan command)
├── quickstart.md        # Phase 1 output (/plan command)
├── contracts/           # Phase 1 output (/plan command)
└── tasks.md             # Phase 2 output (/tasks command)
```

### Source Code (repository root)
```
Configuration Files (modified):
├── vitest.config.js         # Main: Add thresholds + excludes
├── vitest.config.ts         # TypeScript variant (if present)
├── .github/workflows/
│   └── checks.yml           # Main: Add coverage fail condition

Documentation/Reference:
├── README.md                # Update: Document coverage policy
├── CONTRIBUTING.md          # Update: Reference thresholds

Artifacts Generated by CI:
└── review-artifacts/
    ├── coverage/            # Coverage reports
    ├── index.html           # Indexed review packet
    └── coverage-summary.json # Machine-readable summary
```

**Structure Decision**: Web application configuration approach. This feature modifies CI configuration (GitHub Actions) and test infrastructure (Vitest config) without adding new source code modules. Changes are infrastructure-only, affecting root configuration files and CI workflows. No new backend/frontend application code required.

## Phase 0: Outline & Research

### Research Areas Identified
1. **Vitest Coverage Configuration**: Best practices for threshold enforcement
2. **GitHub Actions CI Gates**: Implementing merge-blocking coverage checks
3. **Exclusion Pattern Formats**: Glob pattern syntax for Vitest coverage excludes
4. **Review-Packet Integration**: How to persist coverage data in artifacts
5. **Baseline Calculation**: Handling existing coverage data in transition

### Research Findings Summary
- ✅ Vitest native coverage thresholds via `vitest.config.js` `coverage.all` + `coverage.thresholds` API
- ✅ GitHub Actions can fail steps based on coverage threshold violations detected in test output
- ✅ Coverage exclude patterns use standard glob format (minimatch) in Vitest
- ✅ Review-packet artifact workflow already integrates coverage (extend existing flow)
- ✅ Baseline calculation requires snapshot of current coverage state before enforcement

**Output**: Phase 0 research complete; no NEEDS CLARIFICATION remain.

## Phase 1: Design & Contracts

### 1. Data Model (`data-model.md`)
**Coverage Threshold Entity**:
- `statements: 60` (percentage)
- `branches: 50` (percentage)
- `functions: 60` (percentage)
- `lines: 60` (percentage)
- `all: true` (global uniform enforcement)

**Exclusion Pattern Entity**:
- `**/review-artifacts/**`
- `**/dist/**`, `**/build/**`
- `**/*.test.js`, `**/*.spec.js`, `**/*.spec.ts`
- `**/node_modules/**`
- `**/.git/**`
- `**/coverage/**`

**Coverage Report Entity**:
- Generated by: Vitest during `npm run test:coverage`
- Stored in: CI review-packet artifact
- Format: JSON (coverage-final.json) + HTML index
- Validation: Threshold check logic

### 2. Configuration Contracts (`contracts/`)
**Contract 1: vitest.config.js Coverage Configuration**
- Input: Empty/baseline vitest.config.js
- Output: Config with `coverage.all: true`, `coverage.thresholds: {...}`, `coverage.exclude: [...]`
- Validation: Vitest loads without errors; `npm run test:coverage` applies thresholds

**Contract 2: GitHub Actions CI Step**
- Input: checks.yml workflow
- Output: Coverage check step that exits with code 1 if thresholds not met
- Validation: PR fails when coverage below threshold; passes when above

**Contract 3: Review-Packet Integration**
- Input: Coverage artifacts from Vitest
- Output: Coverage data persisted in review-artifacts/ directory
- Validation: Coverage summary appears in review-packet/index.html

### 3. Test Scenarios (Quickstart Validation)
1. **Happy Path**: Code with ≥60% statements, ≥60% lines, ≥60% functions, ≥50% branches → Test passes, CI succeeds
2. **Failure Path**: Code with <60% statements → Test fails, coverage report generated, CI blocks merge
3. **Exclusion Path**: Non-application code (test files, build artifacts) excluded from metrics → Coverage calculation correct
4. **UI Inclusion Path**: UI components from frontend/src/ui-* included in coverage → Metrics reflect UI tests
5. **Local Consistency**: `npm run test:coverage` locally shows same thresholds as CI → Developer experience parity

### 4. Agent Context Update
Updated via `.specify/scripts/bash/update-agent-context.sh cursor`

**Output**: data-model.md, /contracts/* specs, failing validation tests, quickstart.md, CLAUDE.md

---

## Phase 2: Task Planning Approach
*This section describes what the /tasks command will do - NOT executed during /plan*

**Task Generation Strategy**:
1. Contract fulfillment tasks (vitest.config.js, checks.yml, review-packet integration)
2. Validation tasks (threshold enforcement, exclusion correctness, UI inclusion)
3. Documentation tasks (README + CONTRIBUTING updates)
4. Testing + verification tasks (local validation, CI simulation)

**Ordering Strategy**:
- P0: Configure vitest.config.js with thresholds + excludes [can run in parallel]
- P0: Update checks.yml CI workflow [can run in parallel with vitest config]
- P1: Implement review-packet coverage integration [depends on P0 complete]
- P2: Validation tests (local + CI simulation) [depends on P0, P1]
- P3: Documentation updates [no dependencies]

**Estimated Output**: 12-15 tasks in tasks.md (smaller scope than typical feature; infrastructure-focused)

## Phase 3+: Future Implementation
*These phases are beyond the scope of the /plan command*

**Phase 3**: Task execution (/tasks command creates tasks.md)  
**Phase 4**: Implementation (execute tasks following TDD; tests before configuration)  
**Phase 5**: Validation (run full test suite, verify CI enforcement, document baseline coverage)

---

## Complexity Tracking
*No Constitution violations requiring justification.*

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| (None) | Feature is compliant | N/A |

---

## Progress Tracking
*This checklist is updated during execution flow*

**Phase Status**:
- [x] Phase 0: Research complete (/plan command)
- [x] Phase 1: Design complete (/plan command)
- [x] Phase 2: Task planning complete (/plan command - approach described)
- [ ] Phase 3: Tasks generated (/tasks command)
- [ ] Phase 4: Implementation complete
- [ ] Phase 5: Validation passed

**Gate Status**:
- [x] Initial Constitution Check: PASS
- [x] Post-Design Constitution Check: PASS
- [x] All NEEDS CLARIFICATION resolved
- [x] Complexity deviations documented

---

*Based on Constitution v1.1.0 - See `/memory/constitution.md`*
