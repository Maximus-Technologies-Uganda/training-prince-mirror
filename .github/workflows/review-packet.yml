name: review-packet

on:
  workflow_dispatch:
  push:
    branches: [ development ]

jobs:
  build-review-packet:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps
        run: npm ci

      - name: Run tests with coverage
        run: npx vitest run --coverage

      - name: Prepare review artifacts
        run: |
          mkdir -p review-artifacts
          # Coverage outputs under coverage/
          if [ -d coverage ]; then
            cp -R coverage review-artifacts/coverage-apps || true
          fi
          # Create a simple index.html linking to coverage
          cat > review-artifacts/index.html << 'HTML'
          <!doctype html>
          <html><head><meta charset="utf-8"><title>Coverage Index</title></head>
          <body>
            <h1>Coverage Index</h1>
            <ul>
              <li><a href="coverage-apps/index.html">Overall Coverage Report</a></li>
            </ul>
          </body></html>
          HTML

      - name: Generate review.md
        run: |
          echo "# Review Packet" > review.md
          echo >> review.md
          echo "## Environment" >> review.md
          echo "Node: $(node -v)" >> review.md
          echo "npm:  $(npm -v)" >> review.md
          echo >> review.md
          echo "## Recent Commits" >> review.md
          git --no-pager log -n 20 --pretty=format:"- %h %ad %an: %s" --date=short >> review.md
          echo >> review.md
          echo "## Repo Map (2-level)" >> review.md
          find . -maxdepth 2 -type d -not -path '*/\.*' | sed 's#^\./##' | sort >> review.md

      - name: Coverage summary table
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            echo "## Coverage Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | % |" >> $GITHUB_STEP_SUMMARY
            echo "|---|---:|" >> $GITHUB_STEP_SUMMARY
            node -e "
              const fs = require('fs');
              const summary = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
              const total = summary.total;
              console.log(\`| Statements | \${total.statements.pct}% |\`);
              console.log(\`| Branches   | \${total.branches.pct}% |\`);
              console.log(\`| Functions  | \${total.functions.pct}% |\`);
              console.log(\`| Lines      | \${total.lines.pct}% |\`);
            " >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: review-packet
          path: |
            review.md
            review-artifacts
