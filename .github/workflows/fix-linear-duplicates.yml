name: Fix Linear Duplicates and Remove them

on:
  workflow_dispatch:

jobs:
  fix-linear:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Delete Duplicate Sub-issues
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        run: |
          cat > delete-duplicates.mjs << 'SCRIPT'
          import https from 'https';
          
          const API_KEY = process.env.LINEAR_API_KEY;
          const PARENT_ISSUE_ID = 'PRI-289';
          
          if (!API_KEY) {
            console.error('âŒ LINEAR_API_KEY not set');
            process.exit(1);
          }
          
          async function graphqlRequest(query, variables = {}) {
            return new Promise((resolve, reject) => {
              const body = JSON.stringify({ query, variables });
              const req = https.request({
                method: 'POST',
                hostname: 'api.linear.app',
                path: '/graphql',
                headers: {
                  'Content-Type': 'application/json',
                  'Content-Length': Buffer.byteLength(body),
                  'Authorization': API_KEY
                }
              }, (res) => {
                let data = '';
                res.on('data', (chunk) => (data += chunk));
                res.on('end', () => {
                  try {
                    const json = JSON.parse(data);
                    if (json.errors) {
                      const errorMsg = json.errors.map(e => {
                        if (e.message) return e.message;
                        return JSON.stringify(e);
                      }).join('; ');
                      reject(new Error(errorMsg));
                    } else {
                      resolve(json.data);
                    }
                  } catch (e) {
                    reject(e);
                  }
                });
              });
              req.on('error', reject);
              req.write(body);
              req.end();
            });
          }
          
          async function getSubIssues() {
            console.log('ðŸ” Fetching sub-issues of PRI-289...\n');
            
            const query = `
              query GetSubIssues($id: String!) {
                issue(id: $id) {
                  id
                  identifier
                  children(first: 100) {
                    nodes {
                      id
                      identifier
                      title
                    }
                  }
                }
              }
            `;
            
            const result = await graphqlRequest(query, { id: PARENT_ISSUE_ID });
            return result.issue.children.nodes;
          }
          
          function findDuplicates(issues) {
            const titleMap = {};
            const duplicates = [];
            const keep = [];
            
            for (const issue of issues) {
              if (!titleMap[issue.title]) {
                titleMap[issue.title] = [];
              }
              titleMap[issue.title].push(issue);
            }
            
            for (const title in titleMap) {
              if (titleMap[title].length > 1) {
                console.log(`\nâš ï¸  DUPLICATE: "${title}" (${titleMap[title].length} copies)`);
                titleMap[title].forEach((issue, idx) => {
                  console.log(`   [${idx}] ${issue.identifier}`);
                });
                
                // Keep first, rest are duplicates
                keep.push(titleMap[title][0]);
                for (let i = 1; i < titleMap[title].length; i++) {
                  duplicates.push(titleMap[title][i]);
                }
              } else {
                keep.push(titleMap[title][0]);
              }
            }
            
            return { keep, duplicates };
          }
          
          async function deleteIssue(issueId, issueIdentifier) {
            // Step 1: Archive the issue first (safer than delete)
            console.log(`  Archiving ${issueIdentifier}...`);
            
            const updateQuery = `
              mutation UpdateIssue($id: String!, $input: IssueUpdateInput!) {
                issueUpdate(id: $id, input: $input) {
                  success
                  issue {
                    id
                    identifier
                  }
                }
              }
            `;
            
            try {
              // Try to archive (set archivedAt)
              const updateResult = await graphqlRequest(updateQuery, {
                id: issueId,
                input: { archived: true }
              });
              
              if (updateResult.issueUpdate?.success) {
                console.log(`    âœ… ${issueIdentifier} archived`);
                return true;
              }
              
              // If archiving fails, try direct delete
              const deleteQuery = `
                mutation DeleteIssue($id: String!) {
                  issueDelete(id: $id)
                }
              `;
              
              const deleteResult = await graphqlRequest(deleteQuery, { id: issueId });
              
              if (deleteResult.issueDelete === true) {
                console.log(`    âœ… ${issueIdentifier} deleted`);
                return true;
              } else if (deleteResult.issueDelete) {
                console.log(`    âœ… ${issueIdentifier} removed`);
                return true;
              } else {
                console.log(`    âš ï¸  Could not remove ${issueIdentifier}`);
                return false;
              }
            } catch (err) {
              console.error(`    âŒ Error removing ${issueIdentifier}:`, err.message);
              return false;
            }
          }
          
          async function main() {
            try {
              const subIssues = await getSubIssues();
              console.log(`Found ${subIssues.length} sub-issues\n`);
          
              const { keep, duplicates } = findDuplicates(subIssues);
              
              console.log(`\nðŸ“Š ANALYSIS:`);
              console.log(`   Unique issues: ${keep.length}`);
              console.log(`   Duplicates to remove: ${duplicates.length}\n`);
          
              if (duplicates.length === 0) {
                console.log('âœ… No duplicates found!');
                return;
              }
          
              console.log('ðŸ—‘ï¸  REMOVING DUPLICATES:\n');
              let removed = 0;
              for (const dup of duplicates) {
                const success = await deleteIssue(dup.id, dup.identifier);
                if (success) removed++;
              }
              
              console.log(`\nâœ… Complete!`);
              console.log(`   - Removed/Archived: ${removed}/${duplicates.length} duplicates`);
              
            } catch (err) {
              console.error('âŒ Error:', err.message);
              process.exit(1);
            }
          }
          
          main();
          SCRIPT
          
          node delete-duplicates.mjs
