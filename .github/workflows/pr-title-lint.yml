name: PR Validation

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  validate-pr-title:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    steps:
      - name: Validate PR title starts with PRI-<number>
        uses: actions/github-script@v7
        with:
          script: |
            const raw = context.payload.pull_request.title || '';
            const title = raw.trim();
            core.info(`PR title: "${title}"`);
            const m = title.match(/^([Pp][Rr][Ii]-\d+)(?=[:\s]|$)/);
            if (!m) {
              core.setFailed('PR title must start with your team key: PRI-123: Short description');
            }

  validate-spec-url:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    steps:
      - name: 'Require "Spec: <url>" in PR body'
        uses: actions/github-script@v7
        with:
          script: |
            const body = (context.payload.pull_request?.body || '').trim();
            const match = body.match(/(^|\n)\s*Spec:\s*(https?:\/\/\S+)/i);
            if (!match) {
              core.setFailed('Missing Spec: URL in PR body. Add a line like: "Spec: https://..."');
            } else {
              core.info(`Spec URL found: ${match[2]}`);
            }

  spec-lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: package-lock.json
      - name: Install dependencies
        run: npm ci
      - name: Lint spec acceptance boxes
        run: npm run spec:lint
